<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alpaca BTC Ladder Bot (Paper)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>Alpaca BTC‑USD Ladder Bot (Paper)
        <span id="bot-state" class="badge badge-off">Stopped</span>
    </h1>
    <div id="last-action" class="banner"></div>
    <div class="chips" id="state-chips">
        <span class="chip" id="chip-bot">—</span>
        <span class="chip" id="chip-flat">—</span>
        <span class="chip" id="chip-orders">—</span>
        <span class="chip" id="chip-risk">—</span>
    </div>
    <!-- Top PnL & Funds Strip -->
    <div id="pnl-strip" class="pnl-strip">
        <div class="pnl-item" title="Net position size and average entry price">
            <div class="label">Your position</div>
            <div class="value"><span id="strip-pos">0</span> @ <span id="strip-avg">0</span></div>
        </div>
        <div class="pnl-item" title="Unrealized P&L = (Last − Avg) × Position">
            <div class="label">Open P&L</div>
            <div class="value"><span id="strip-upnl" class="mono">0</span> (<span id="strip-upct">0</span>%)</div>
        </div>
        <div class="pnl-item" title="Realized P&L for trades filled today (UTC)">
            <div class="label">Day P&L</div>
            <div class="value mono" id="strip-day">0</div>
        </div>
        <div class="pnl-item" title="Capital used = |Position| × Last">
            <div class="label">Capital used</div>
            <div class="value mono" id="strip-used">0</div>
        </div>
        <div class="pnl-item" title="Capacity remaining = Max Ladder Notional − Capital used">
            <div class="label">Capacity rem.</div>
            <div class="value mono" id="strip-cap">0</div>
        </div>
        <div class="pnl-item" title="Open ladder rungs currently working">
            <div class="label">Pending orders</div>
            <div class="value mono" id="strip-open">0</div>
        </div>
        <div class="pnl-item" title="Cash available in Alpaca account">
            <div class="label">Cash</div>
            <div class="value mono" id="strip-cash">—</div>
        </div>
        <div class="pnl-item" title="Account equity (portfolio value)">
            <div class="label">Equity</div>
            <div class="value mono" id="strip-equity">—</div>
        </div>
        <div class="pnl-item" title="Buying power available for new positions">
            <div class="label">Buying power</div>
            <div class="value mono" id="strip-bp">—</div>
        </div>
    </div>

    <!-- Compact Side Panel -->
    <aside id="side-panel" class="side-panel">
        <h3>Snapshot</h3>
        <div class="kv"><span>Open rungs</span><span id="sp-open">0</span></div>
        <div class="kv"><span>Position (BTC)</span><span id="sp-position">0</span></div>
        <div class="kv"><span>Avg price</span><span id="sp-avg">0</span></div>
        <div class="kv"><span>Last price</span><span id="sp-last">0</span></div>
        <div class="kv"><span>Unrealized</span><span id="sp-upnl" class="mono">0</span></div>
        <div class="kv"><span>Realized</span><span id="sp-rpnl" class="mono">0</span></div>
        <div class="kv"><span>Capital used</span><span id="sp-used">0</span></div>
        <div class="kv"><span>Capacity rem.</span><span id="sp-remaining">0</span></div>
        <div class="kv"><span>Rung range</span><span id="sp-range">-</span></div>
        <div class="kv small"><span>Last action</span><span id="sp-action">-</span></div>
        <div class="mini-rungs">
            <div class="mini-title small">Next rungs (approx)</div>
            <ul id="sp-rungs" class="mono small"></ul>
        </div>
    </aside>

    <!-- Quick Metrics -->
    <section id="metrics">
        <div class="card">
            <div class="label">Position</div>
            <div class="value" id="m-position">0</div>
        </div>
        <div class="card">
            <div class="label">Avg Price</div>
            <div class="value" id="m-avgprice">0</div>
        </div>
        <div class="card">
            <div class="label">Realized PnL</div>
            <div class="value" id="m-pnl">0</div>
        </div>
        <div class="card">
            <div class="label">Open Orders</div>
            <div class="value" id="m-openorders">0</div>
        </div>
        <div class="card">
            <div class="label">Last Price</div>
            <div class="value" id="m-last">0</div>
        </div>
        <div class="card">
            <div class="label">Unrealized PnL</div>
            <div class="value" id="m-upnl" class="upnl">0</div>
        </div>
        <div class="card">
            <div class="label">Capital Used (est)</div>
            <div class="value" id="m-capused">0</div>
        </div>
        <div class="card">
            <div class="label">Max Ladder Notional</div>
            <div class="value" id="m-maxnotional">0</div>
        </div>
        <div class="card">
            <div class="label">Capacity Rem. (est)</div>
            <div class="value" id="m-remaining">0</div>
        </div>
    </section>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="status-tab">Status</button>
        <button class="tab-btn" data-tab="autopilot-tab">Autopilot</button>
        <button class="tab-btn" data-tab="chart-tab">Chart</button>
    </div>

    <!-- Status Tab (wraps config + status panels) -->
    <div id="status-tab" class="tab-content">
    <!-- Ladder Config -->
    <section id="ladder-section">
        <h2>Ladder Configuration</h2>
        <div class="help">Steps × Size = total BTC placed; Interval = $ distance between rungs. Max exposure caps live position size. Circuit breaker cancels all rungs and stops when 1‑min % range exceeds the threshold.</div>
        <div class="presets">
            Presets:
            <button type="button" id="preset-cons">Conservative</button>
            <button type="button" id="preset-neut">Neutral</button>
            <button type="button" id="preset-aggr">Aggressive</button>
        </div>
        <form id="ladder-form">
            <label>Symbol:
                <input name="symbol" value="BTC/USD" required>
            </label>
            <label>Direction:
                <select name="direction">
                    <option value="BUY">Buy (Long)</option>
                    <option value="SELL">Sell (Short)</option>
                </select>
            </label>
            <label>Steps:
                <input name="steps" type="number" value="5" min="1" max="20">
            </label>
            <label title="Dollar distance between rungs (spacing on the price ladder)">Interval (USD):
                <input name="interval" type="number" step="0.01" value="200">
            </label>
            <label title="USD notional per rung; bot converts to BTC using the last price">Per‑rung notional (USD):
                <input name="size" type="number" step="0.01" value="1000">
            </label>
            <label title="Maximum dollar exposure; bot converts to BTC using the last price">Max exposure (USD):
                <input name="max_exposure" type="number" step="0.01"
                       value="5000">
            </label>
            <div class="actions">
                <button type="submit" id="start-btn" title="Start managing the ladder using the settings below">Start Ladder</button>
                <button type="button" id="stop-btn" class="secondary" title="Cancel all open ladder orders and stop the bot">Stop Ladder</button>
                <button type="button" id="close-all" class="danger" title="Instantly close the entire position at market and cancel all rungs">Close All (Market)</button>
                <button type="button" id="cancel-open" class="secondary" title="Cancel all open ladder rungs only (keep any position)">Cancel Open (Rungs Only)</button>
                <span class="spacer"></span>
                <button type="button" id="nudge-up" title="Shift all rungs up by one interval">Nudge Up</button>
                <button type="button" id="nudge-down" title="Shift all rungs down by one interval">Nudge Down</button>
                <button type="button" id="recenter-now" title="Rebuild ladder centered on the current price">Recenter</button>
                <label title="Automatically recenter when price drifts more than one interval"><input type="checkbox" id="auto-recenter"> Auto‑recenter</label>
            </div>
            <div class="action-help small">
                <b>What the buttons do:</b>
                <ul>
                    <li><b>Start Ladder</b>: begins placing rungs using the settings above.</li>
                    <li><b>Stop Ladder</b>: cancels all open rungs and stops the bot.</li>
                    <li><b>Close All (Market)</b>: stops the bot, cancels rungs, and market‑closes your entire position.</li>
                    <li><b>Cancel Open</b>: cancels rungs only; your current position remains.</li>
                    <li><b>Nudge Up/Down</b>: shift every rung by one interval.</li>
                    <li><b>Recenter</b>: rebuild the ladder around the current market price.</li>
                    <li><b>Auto‑recenter</b>: auto recenter when price drifts more than one interval.</li>
                </ul>
            </div>
        </form>

        <div id="risk-panel" class="panel">
            <h3>Risk Controls</h3>
            <label><input type="checkbox" id="risk-enable-loss"> Daily loss cap (USD):</label>
            <input id="risk-losscap" type="number" value="200" step="1">
            <label><input type="checkbox" id="risk-enable-vol" checked> Circuit breaker (1‑min % range):</label>
            <input id="risk-vol" type="number" value="0.7" step="0.1">
        </div>

        <div id="preview" class="panel">
            <h3>Ladder Preview</h3>
            <div class="preview-grid">
                <div>
                    <div>Total BTC: <span id="preview-total-btc">0</span></div>
                    <div>Total notional (≈): $<span id="preview-total-notional">0</span></div>
                    <div>Capital used now (≈): $<span id="preview-used">0</span></div>
                    <div>Capacity remaining (≈): $<span id="preview-remaining">0</span></div>
                    <div>Range: $<span id="preview-min">0</span> → $<span id="preview-max">0</span></div>
                </div>
                <div>
                    <div>Rungs:</div>
                    <ul id="preview-list" class="mono small"></ul>
                </div>
            </div>
        </div>

        <div class="panel legend">
            <h3>Controls & Metrics</h3>
            <ul class="small">
                <li><b>Steps</b>: number of rungs (orders) placed.</li>
                <li><b>Interval</b>: dollar distance between consecutive rungs.</li>
                <li><b>Per‑rung notional (USD)</b>: dollars per rung. Converted to BTC at the last price.</li>
                <li><b>Max exposure (USD)</b>: maximum dollars deployed. Converted to BTC at the last price.</li>
                <li><b>Capital Used</b>: current position × last price.</li>
                <li><b>Max Ladder Notional</b>: steps × size × last price.</li>
                <li><b>Capacity Remaining</b>: Max Notional − Capital Used (approx).</li>
                <li><b>Nudge</b>: shift the ladder by one interval without changing spacing.</li>
                <li><b>Recenter</b>: rebuild ladder centered on current price.</li>
                <li><b>Circuit breaker</b>: if 1‑min high/low range exceeds your % threshold, the bot cancels all rungs and stops. You must press Start to resume.</li>
            </ul>
        </div>
    </section>

    <section id="autopilot-section">
        <h2>Strategy Autopilot <span id="auto-state" class="badge badge-off">Idle</span></h2>
        <div class="help">Configure a momentum + RSI driven controller that automatically keeps the ladder aligned with the trend. The bot adjusts spacing, steps, and size based on intraday volatility and trend strength. Autopilot converts USD notionals to the asset using the latest price.</div>
        <form id="autopilot-form" class="autopilot-form">
            <div class="auto-grid">
                <label>Symbol
                    <input name="symbol" value="BTC/USD" required>
                </label>
                <label>Fast EMA window
                    <input name="fast_window" type="number" value="12" min="3" max="60">
                </label>
                <label>Slow EMA window
                    <input name="slow_window" type="number" value="26" min="5" max="240">
                </label>
                <label>RSI window
                    <input name="rsi_window" type="number" value="14" min="5" max="240">
                </label>
                <label>RSI overbought
                    <input name="overbought" type="number" value="70" min="50" max="95" step="0.1">
                </label>
                <label>RSI oversold
                    <input name="oversold" type="number" value="30" min="5" max="50" step="0.1">
                </label>
                <label>Base interval (USD)
                    <input name="base_interval" type="number" value="150" step="0.01">
                </label>
                <label>Base steps
                    <input name="base_steps" type="number" value="7" min="3" max="20">
                </label>
                <label>Per-rung notional (USD)
                    <input name="rung_notional" type="number" value="1000" step="0.01">
                </label>
                <label>Max deployment (USD)
                    <input name="max_notional" type="number" value="7000" step="0.01">
                </label>
                <label>Volatility lookback (bars)
                    <input name="volatility_lookback" type="number" value="60" min="10" max="500">
                </label>
                <label>Risk multiplier
                    <input name="risk_multiplier" type="number" value="1.0" min="0.1" max="5" step="0.1">
                </label>
                <label>Poll seconds
                    <input name="poll_seconds" type="number" value="30" min="10" max="120" step="5">
                </label>
            </div>
            <div class="actions">
                <button type="submit" id="start-autopilot">Start Autopilot</button>
                <button type="button" id="stop-autopilot" class="secondary">Stop Autopilot</button>
            </div>
        </form>
        <div class="panel autopilot-panel">
            <h3>Autopilot Telemetry</h3>
            <div class="autopilot-grid">
                <div class="kv"><span>Last signal</span><span id="auto-last-signal">—</span></div>
                <div class="kv"><span>Last reason</span><span id="auto-last-reason">—</span></div>
                <div class="kv"><span>Trend strength</span><span id="auto-trend">—</span></div>
                <div class="kv"><span>Volatility (1m)</span><span id="auto-vol">—</span></div>
                <div class="kv"><span>RSI</span><span id="auto-rsi">—</span></div>
                <div class="kv"><span>Signal price</span><span id="auto-price">—</span></div>
                <div class="kv"><span>Applied ladder</span><span id="auto-applied">—</span></div>
                <div class="kv"><span>Last run</span><span id="auto-last-run">—</span></div>
                <div class="kv"><span>Error</span><span id="auto-error">—</span></div>
            </div>
            <h4>Active config</h4>
            <pre id="auto-config" class="mono small">{}</pre>
        </div>
    </section>

    <!-- Bot Status & Tables -->
    <section id="status-section">
        <h2>Bot Status</h2>
        <div class="status-grid">
            <div>
                <h3>Summary (auto-refresh)</h3>
                <pre id="status-box" class="mono">{}</pre>
            </div>
            <div>
                <h3>Recent Logs</h3>
                <pre id="log-box" class="mono"></pre>
            </div>
        </div>
        <div class="tables">
            <div class="table-wrap">
                <h3>Open Orders</h3>
                <table id="open-orders">
                    <thead>
                        <tr>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Limit</th>
                            <th>Status</th>
                            <th>Id</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="table-wrap">
                <h3>Recent Fills</h3>
                <table id="filled-orders">
                    <thead>
                        <tr>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Time</th>
                            <th>Id</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="table-wrap">
                <h3>Live Activity</h3>
                <table id="activity">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Event</th>
                            <th>Detail</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>
    </div>

    <!-- Autopilot Tab -->
    <section id="autopilot-tab" class="tab-content hidden">
        <section id="autopilot-section">
            <h2>Strategy Autopilot <span id="auto-state" class="badge badge-off">Idle</span></h2>
            <div class="help autopilot-intro">The autopilot monitors the last 65 minutes of price action, compares fast and slow EMAs, checks RSI, and then either realigns the ladder or pauses it when conditions are unfavorable. All USD inputs are converted to the symbol you select using the latest price from Alpaca’s paper data feed.</div>
            <div class="autopilot-columns">
                <div class="auto-col">
                    <form id="autopilot-form" class="autopilot-form">
                        <div class="auto-grid">
                            <label>Symbol
                                <input name="symbol" value="BTC/USD" required>
                                <span class="field-help">Trading pair to monitor and trade.</span>
                            </label>
                            <label>Fast EMA window
                                <input name="fast_window" type="number" value="12" min="3" max="60">
                                <span class="field-help">Short trend lookback (bars) for momentum swings.</span>
                            </label>
                            <label>Slow EMA window
                                <input name="slow_window" type="number" value="26" min="5" max="240">
                                <span class="field-help">Longer trend lookback that the fast EMA is compared against.</span>
                            </label>
                            <label>RSI window
                                <input name="rsi_window" type="number" value="14" min="5" max="240">
                                <span class="field-help">Number of bars used for RSI; helps judge overbought/oversold.</span>
                            </label>
                            <label>RSI overbought
                                <input name="overbought" type="number" value="70" min="50" max="95" step="0.1">
                                <span class="field-help">Above this RSI, autopilot assumes upside momentum is stretched.</span>
                            </label>
                            <label>RSI oversold
                                <input name="oversold" type="number" value="30" min="5" max="50" step="0.1">
                                <span class="field-help">Below this RSI, downside momentum may be exhausted.</span>
                            </label>
                            <label>Base interval (USD)
                                <input name="base_interval" type="number" value="150" step="0.01">
                                <span class="field-help">Starting distance between ladder rungs before adjustments.</span>
                            </label>
                            <label>Base steps
                                <input name="base_steps" type="number" value="7" min="3" max="20">
                                <span class="field-help">Default number of rungs the ladder should have.</span>
                            </label>
                            <label>Per-rung notional (USD)
                                <input name="rung_notional" type="number" value="1000" step="0.01">
                                <span class="field-help">Dollar amount per rung, converted to the asset at runtime.</span>
                            </label>
                            <label>Max deployment (USD)
                                <input name="max_notional" type="number" value="7000" step="0.01">
                                <span class="field-help">Hard cap of USD exposure the autopilot is allowed to deploy.</span>
                            </label>
                            <label>Volatility lookback (bars)
                                <input name="volatility_lookback" type="number" value="60" min="10" max="500">
                                <span class="field-help">How many bars to use when measuring 1m volatility spikes.</span>
                            </label>
                            <label>Risk multiplier
                                <input name="risk_multiplier" type="number" value="1.0" min="0.1" max="5" step="0.1">
                                <span class="field-help">Scale ladder spacing/size up (>1) or down (&lt;1) from the base.</span>
                            </label>
                            <label>Poll seconds
                                <input name="poll_seconds" type="number" value="30" min="10" max="120" step="5">
                                <span class="field-help">How often the controller evaluates signals and updates.</span>
                            </label>
                        </div>
                        <div class="actions">
                            <button type="submit" id="start-autopilot">Start Autopilot</button>
                            <button type="button" id="stop-autopilot" class="secondary">Stop Autopilot</button>
                        </div>
                    </form>
                    <div class="panel autopilot-actions">
                        <h3>Button cheat sheet</h3>
                        <ul class="small">
                            <li><b>Start Autopilot</b> kicks off the EMA/RSI controller and lets it take over ladder sizing.</li>
                            <li><b>Stop Autopilot</b> immediately halts the controller; ladder settings stay wherever they last landed.</li>
                        </ul>
                        <p class="small">Keep the ladder running if you want fills during autopilot pauses—the controller only changes configuration and cancels orders when conditions fail your thresholds.</p>
                    </div>
                </div>
                <div class="auto-col">
                    <div class="panel autopilot-panel">
                        <h3>Autopilot Telemetry</h3>
                        <div class="autopilot-grid">
                            <div class="kv"><span>Last signal</span><span id="auto-last-signal">—</span></div>
                            <div class="kv"><span>Last reason</span><span id="auto-last-reason">—</span></div>
                            <div class="kv"><span>Trend strength</span><span id="auto-trend">—</span></div>
                            <div class="kv"><span>Volatility (1m)</span><span id="auto-vol">—</span></div>
                            <div class="kv"><span>RSI</span><span id="auto-rsi">—</span></div>
                            <div class="kv"><span>Signal price</span><span id="auto-price">—</span></div>
                            <div class="kv"><span>Applied ladder</span><span id="auto-applied">—</span></div>
                            <div class="kv"><span>Last run</span><span id="auto-last-run">—</span></div>
                            <div class="kv"><span>Error</span><span id="auto-error">—</span></div>
                        </div>
                        <h4>Active config</h4>
                        <pre id="auto-config" class="mono small">{}</pre>
                    </div>
                    <div class="panel autopilot-usage">
                        <h3>Capital vs. P/L while Autopilot runs</h3>
                        <p class="small">This chart plots capital currently deployed (position × last price) against the combined realized and unrealized P/L reported by Alpaca. Data is captured every status poll, so you can confirm how hard the controller is working.</p>
                        <canvas id="autopilot-usage-canvas" width="600" height="280"></canvas>
                    </div>
                </div>
            </div>
            <div class="panel autopilot-field-guide">
                <h3>How the fields influence the controller</h3>
                <dl>
                    <dt>EMA windows</dt>
                    <dd>The controller looks for the fast EMA to cross or diverge from the slow EMA; bigger windows make the strategy slower to react.</dd>
                    <dt>RSI thresholds</dt>
                    <dd>RSI outside the overbought/oversold band tells the autopilot to favor reversions; inside the band it tends to pause.</dd>
                    <dt>Base interval &amp; steps</dt>
                    <dd>Serve as the starting ladder blueprint. Volatility and risk multiplier stretch or compress them in real time.</dd>
                    <dt>Volatility lookback</dt>
                    <dd>Spikes beyond recent volatility shrink position sizing or halt the ladder until conditions calm down.</dd>
                    <dt>Risk multiplier &amp; max deployment</dt>
                    <dd>Place an upper bound on exposure. Use a multiplier below 1 if you want a gentler ladder during choppy sessions.</dd>
                    <dt>Poll cadence</dt>
                    <dd>Lower values mean quicker reactions but more API calls. Higher values smooth out noise.</dd>
                </dl>
            </div>
        </section>
    </section>

    <!-- Chart Tab (optional) -->
    <section id="chart-tab" class="tab-content hidden">
        <h2>Historical Candles</h2>
        <div>
            Symbol:
            <input id="chart-symbol" type="text" value="BTC/USD" size="8">
            Timeframe:
            <select id="chart-timeframe">
                <option value="5Min" selected>5Min</option>
                <option value="15Min">15Min</option>
                <option value="1Hour">1Hour</option>
                <option value="1Day">1Day</option>
            </select>
            <button id="load-chart">Load Chart</button>
        </div>
        <canvas id="candles-canvas" width="900" height="400"></canvas>
    </section>

    <script src="/static/script.js"></script>
</body>
</html>
